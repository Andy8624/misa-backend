// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator erd {
  provider              = "prisma-erd-generator"
  output                = "ERD.pdf" // có đuôi .svg hoặc .png hoặc .pdf
  disableRelationLines  = true
  includeRelationFields = false
}

// Bảng lưu thông tin của Kế toán (Accountant)
model Accountant {
  id          String   @id @default(uuid())
  email       String   @unique
  fullName    String   @map("full_name") // Họ và tên
  phoneNumber String   @map("phone_number") // Số điện thoại 
  birthDate   DateTime @map("birth_date") // Ngày sinh
  gender      String // Giới tính
  password    String // Mật khẩu

  avatarUrl String @default("default-avatar.jpg") @map("avatar_url")
  address   String @default("Not provided")
  zipCode   String @default("00000") @map("zip_code")

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Khóa ngoại
  customers Customer[] // Một kế toán có nhiều công ty

  @@map("accountants")
}

// Bảng chứa thông tin các công ty (Customer) mà kế toán (Accountant) đang hợp tác làm việc
model Customer {
  id             String   @id @default(uuid())
  logoUrl        String?  @map("logo_url") // Url ảnh logo
  businessType   String   @map("business_type") // Loại hình doanh nghiệp (Doanh nghiệp/ Hộ kinh doanh)
  taxCode        String   @map("tax_code") // Mã số thuế
  customerName   String   @map("customer_name") // Tên khách hàng
  customerGroup  String?  @map("customer_group") // Nhóm khách hàng
  foundedDate    DateTime @map("founded_date") // Ngày thành lập
  vatTaxType     String   @map("vat_tax_type") // Kê khai thuế GTGT (tháng/quý)
  customerStatus String   @map("customer_status") // Trạng thái khách hàng

  // Thông tin địa chỉ
  province      String // Tỉnh/Thành phố
  district      String // Quận/Huyện
  ward          String? // Phường/Xã
  streetAddress String  @map("street_address") // Số nhà, tên đường, phố
  fullAddress   String  @map("full_address") // Địa chỉ đầy đủ

  contactName        String @map("contact_name")
  contactPhoneNumber String @map("contact_phone_number") // Số điện thoại 
  contactEmail       String @map("contact_email")
  contactPosition    String @map("contact_position") // Chức danh

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Quan hệ với accountant
  accountant   Accountant @relation(fields: [accountantId], references: [id])
  accountantId String     @map("accountant_id")

  // Mang danh sách đối tượng khác
  partners  Partner[] // Một công ty có nhiều đối tác (KHÁCH HÀNG - NHÀ CUNG CẤP)
  employees Employee[] // Một công ty có nhiều nhân viên

  @@map("customers")
}

// Bảng lưu thông tin các đối tác (Partners) 
// của từng công ty (Customer) mà kế toán (Accountant) đang làm
// Partners có thể là KHÁCH HÀNG hoặc NHÀ CUNG CẤP
model Partner {
  id          String  @id @default(uuid())
  partnerCode String  @map("partner_code") // Mã khách hàng
  partnerType String  @map("partner_type") // Loại đối tác (CLIENT', 'SUPPLIER')
  legalType   String  @map("legal_type") // Loại pháp lý (Cá nhân - tổ chức)
  taxCode     String  @map("tax_code") // Mã số thuế
  govUnitCode String? @map("gov_unit_code") // Mã số đơn vị có quan hệ với Ngân sách

  fullName    String  @map("full_name") // Tên 
  address     String // Địa chỉ 
  phoneNumber String  @map("phone_number") // Số điện thoại 
  websiteUrl  String? @map("website_url") // Đường dẫn đến website của đối tác (Partners)

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Khóa ngoại
  // Quan hệ với customer
  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String   @map("customer_id")

  // Bao gồm các tài khoản của đối tượng này
  bankAccounts BankAccount[] // Một đối tác có nhiều tài khoản ngân hàng

  @@map("partners")
}

model Bank {
  id                 String @id @default(uuid())
  fullName           String @map("full_name") // Tên tiếng việt
  shortName          String @map("short_name") // Tên viết tắt
  englishName        String @map("english_name") // Tên tiếng anh
  headquarterAddress String @map("headquarter_address") // Địa chỉ trụ sở chính
  description        String // Mô tả
  logoUrl            String @map("logo_url") // Địa chỉ logo ngân hàng

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Bao gồm danh sách các tài khoản thuộc ngân hàng này
  bankAccounts BankAccount[]

  @@map("banks")
}

model BankAccount {
  id                   String @id @default(uuid())
  accountNumber        String @map("account_number") // Số tài khoản
  provinceOrCity       String @map("province_or_city") // Tỉnh thành phố
  branchName           String @map("branch_name") // Tên chi nhánh
  branchAddress        String @map("branch_address") // Địa chỉ chi nhánh
  deltailBranchAddress String @map("detail_branch_address") // Địa chỉ chi tiết chi nhánh

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Khóa ngoại
  // Quan hệ với đối tác
  Partner   Partner? @relation(fields: [partnerId], references: [id])
  partnerId String?  @map("partner_id")

  // Quan hệ với nhân viên
  Employee   Employee? @relation(fields: [employeeId], references: [id])
  employeeId String?   @map("employee_id")

  // Quan hệ với ngân hàng
  Bank   Bank?   @relation(fields: [bankId], references: [id])
  bankId String? @map("bank_id")

  @@map("bank_accounts")
}

model Employee {
  id           String @id @default(uuid())
  employeeCode String @map("employee_code") // Mã nhân viên (NV0001)

  // Thông tin cá nhân
  fullName           String   @map("full_name")
  dob                DateTime // Ngày sinh
  sex                String // Giới tính Male - Female - Other
  address            String // Địa chỉ
  position           String // Chức danh
  passportNumber     String?  @map("passport_number") // Số hộ chiếu
  phoneNumber        String   @map("phone_number") // Số điện thoại
  idCardNumber       String   @map("id_card_number") // Số CCCD
  idCardIssuedDate   String   @map("id_card_issued_date") // Ngày cấp CCCD
  idCardPlaceOfIssue String   @map("id_card_place_of_issue") // Nơi cấp CCCD

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Khóa ngoại
  // Quan hệ với customer
  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String   @map("customer_id")

  // Mang danh sách đối tượng khác
  bankAccounts BankAccount[] // Một nhân viên có nhiều tài khoản ngân hàng

  @@map("employees")
}

model WarrantyPeriod {
  id          String @id @default(uuid())
  description String // Mô tả

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  goodsAndServices GoodsAndServices[]

  @@map("warranty_periods")
}

model GoodsAndServices {
  id                   String @id @default(uuid())
  name                 String
  code                 String
  vatDecrease          String @map("vat_decrease")
  minimumStockQuantity Int    @map("minimum_stock_quantity")
  image                String
  source               String
  description          String
  purchaseDescription  String @map("purchase_description")
  saleDescription      String @map("sale_description")
  latestPurchasePrice  String @map("latest_purchase_price")

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Quan hệ với Unit
  Unit   Unit?   @relation(fields: [unitId], references: [id])
  unitId String? @map("unit_id")

  // Quan hệ với WarrantyPeriod
  WarrantyPeriod   WarrantyPeriod? @relation(fields: [warrantyPeriodId], references: [id])
  warrantyPeriodId String?         @map("warranty_period_id")

  // Quan hệ với VatTax
  VatTax   VatTax? @relation(fields: [vatTaxId], references: [id])
  vatTaxId String? @map("vat_tax_id")

  // Quan hệ với AccountMainSystem (nhiều foreign keys)
  WarehouseAccount   AccountMainSystem? @relation("WarehouseAccount", fields: [warehouseAccountId], references: [id])
  warehouseAccountId String?            @map("warehouse_account_id")

  ReturnAccount   AccountMainSystem? @relation("ReturnAccount", fields: [returnAccountId], references: [id])
  returnAccountId String?            @map("return_account_id")

  RevenueAccount   AccountMainSystem? @relation("RevenueAccount", fields: [revenueAccountId], references: [id])
  revenueAccountId String?            @map("revenue_account_id")

  ExpenseAccount   AccountMainSystem? @relation("ExpenseAccount", fields: [expenseAccountId], references: [id])
  expenseAccountId String?            @map("expense_account_id")

  SalesAllowanceAccount   AccountMainSystem? @relation("SalesAllowanceAccount", fields: [salesAllowanceAccountId], references: [id])
  salesAllowanceAccountId String?            @map("sales_allowance_account_id")

  DiscountAccount   AccountMainSystem? @relation("DiscountAccount", fields: [discountAccountId], references: [id])
  discountAccountId String?            @map("discount_account_id")

  // Mang danh sách đối tượng khác
  GoodsAndServicesGroupMapping GoodsAndServicesGroupMapping[]

  @@map("goods_and_services")
}

model GoodsAndServicesGroup {
  id     String @id @default(uuid())
  code   String
  name   String
  status String

  // Mang danh sách đối tượng khác
  GoodsAndServicesGroupMapping GoodsAndServicesGroupMapping[]

  // Self-referential relationship
  parentGroup   GoodsAndServicesGroup? @relation("ParentGroup", fields: [parentGroupId], references: [id])
  parentGroupId String?                @map("parent_group_id")

  // Quan hệ ngược - các nhóm con
  childGroups GoodsAndServicesGroup[] @relation("ParentGroup")

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("goods_and_services_groups")
}

model GoodsAndServicesGroupMapping {
  id String @id @default(uuid())

  // Quan hệ với GoodsAndServices
  goodsAndServices   GoodsAndServices @relation(fields: [goodsAndServicesId], references: [id], onDelete: Cascade)
  goodsAndServicesId String           @map("goods_and_services_id")

  // Quan hệ với GoodsAndServicesGroup
  goodsAndServicesGroup   GoodsAndServicesGroup @relation(fields: [goodsAndServicesGroupId], references: [id], onDelete: Cascade)
  goodsAndServicesGroupId String                @map("goods_and_services_group_id")

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  // Đảm bảo không có duplicate mapping
  @@unique([goodsAndServicesId, goodsAndServicesGroupId])
  @@map("goods_and_services_group_mappings")
}

model Unit {
  id          String @id @default(uuid())
  name        String
  status      String
  description String

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Mang danh sách đối tượng khác
  goodsAndServices GoodsAndServices[]

  @@map("units")
}

model VatTax {
  id      String @id @default(uuid())
  name    String
  percent Int

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Mang danh sách đối tượng khác
  goodsAndServices GoodsAndServices[]

  @@map("vat_taxes")
}

model AccountMainSystem {
  id              String @id @default(uuid())
  accountCode     String @map("account_code")
  accountName     String @map("account_name")
  accountType     String @map("account_type")
  engAccountName  String @map("eng_account_name")
  describeAccount String @map("describe_account")

  // Auditing
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Quan hệ ngược với GoodsAndServices (1 AccountMainSystem có thể được sử dụng bởi nhiều GoodsAndServices)
  warehouseGoods      GoodsAndServices[] @relation("WarehouseAccount")
  returnGoods         GoodsAndServices[] @relation("ReturnAccount")
  revenueGoods        GoodsAndServices[] @relation("RevenueAccount")
  expenseGoods        GoodsAndServices[] @relation("ExpenseAccount")
  salesAllowanceGoods GoodsAndServices[] @relation("SalesAllowanceAccount")
  discountGoods       GoodsAndServices[] @relation("DiscountAccount")

  @@map("account_main_systems")
}
